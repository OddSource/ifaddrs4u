#!/usr/bin/env bash

java="${JAVA_HOME}/bin/java"

export ASAN_OPTIONS=detect_stack_use_after_return=1:detect_leaks=1:verify_asan_link_order=0
export LSAN_OPTIONS=print_suppressions=1:suppressions=build/lsan-suppressions.txt
LD_PRELOAD="$(realpath "$(gcc -print-file-name=libasan.so)") $(realpath "$(gcc -print-file-name=libstdc++.so)")"
export LD_PRELOAD

# only echo to stderr to prevent "Corrupted channel by directly writing to native stream in forked JVM 1"
>&2 echo "Wrapping java command as follows to enable Address Sanitizer:"
>&2 echo "export ASAN_OPTIONS='${ASAN_OPTIONS}'"
>&2 echo "export LSAN_OPTIONS='${LSAN_OPTIONS}'"
>&2 echo "export LD_PRELOAD='${LD_PRELOAD}'"
>&2 echo "exec '${java}'" "$@"
>&2 echo

exec "$java" "$@"
